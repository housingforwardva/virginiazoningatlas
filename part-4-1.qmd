---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup

# Load necessary packages.

library(tidycensus)
library(tidyverse)
library(hdatools)
library(ggiraph)
library(scales)
library(patchwork)
library(ggtext)
library(kableExtra)
library(leaflet)
library(zoo)

```

Richmond Magazine's ["It Takes More Than A Village"](https://richmondmagazine.com/news/features/it-takes-more-than-a-village/) article recently highlighted the challenges the Richmond regional housing market continues to face. Housing costs - both for rental and homeownership - are up significantly from where they were over a decade ago and the abundant supply has dwindled to a trickle.

The Census Building Permit Survey from 2000 to 2022 shows that single-family construction starts have been on the way to recovery since the Great Recession.[^part-4-1-1] But they still pale in comparison to pre-Recession numbers. The market shift to multifamily in the past few years speaks to not only growing preferences among households, but also the challenges residents face in accessing the homeownership market (e.g., interest rates, increasing debt, competition with cash buyers, etc.).

[^part-4-1-1]: Adam Pagnucco, a writer on state and local politics, has written about the potential pitfalls of Census Building Permit Survey in accurately accounting for building starts in his piece [This Mess Must Be Fixed](https://montgomeryperspective.com/2023/06/29/this-mess-must-be-fixed/). To that end, it must be noted that BPS relies on localities to voluntarily submit accurate data to the Census Bureau. Estimates shown may not be completely accurate depending on the locality and their participation in the survey. In lieu of data directly from the locality, BPS often serves as the sole source of this information.

The region, not unlike others in the Commonwealth, is very much lacking in the construction of smaller two to four unit buildings, so often seen in the historic neighborhoods of Richmond. This "Missing Middle" is literally missing in the market.

```{r}
#| label: fig-bps
#| fig-cap: "Total new residential building permits issued from 2000 to 2023"

# Create a visualization that shows where housing is being built. Where is more diverse housing being built? Where is single-family housing being built the most? How does that compare to population growth in those localities?

bps <- read_rds("data/planrva/rds/rva_bps.rds") |> # Load in Building Permits Survey data.
  mutate(type = case_when( # Group "Missing Middle" housing together.
    type == "2-units" ~ "2-4 units",
    type == "3-4 units" ~ "2-4 units",
    TRUE ~ type
  )) |> 
  group_by(name_long, year, type) |> # Aggregate to locality and housing type.
  summarise(units = sum(units)) |> 
  group_by(name_long) |> # Group by locality.
  mutate(total = sum(units)) # Calculate the total number of new permits for entire time period.


# Summarize the percentage of units developed by type for the narrative.

bps_summary <- bps |> 
  group_by(type) |> # Aggregate by housing type.
  summarise(units = sum(units)) |> 
  mutate(pct = units/sum(units)) # Calculate the percentage of type of units for the region.


subtitle_text <- "Few <span style = 'color:#40C0C0'><b>2-4 unit housing</span> has been built between 2000 to 2023"
  
bps_plot <- ggplot(bps,
       aes(x = year,
           y = units,
           fill = type,
           data_id = units,
           tooltip = number_format(big.mark =",")(units))) + 
  geom_col_interactive(position = "stack", width = 0.8) +
  facet_wrap(~type) +
  theme_hfv(base_size = 10) + 
  scale_fill_hfv() +
  scale_y_continuous(labels = number_format(big.mark = ",", style_positive = "plus")) +
  labs(title = "Total new residential building permits issued in the PlanRVA region",
       subtitle = subtitle_text,
       caption = "**Source:** U.S. Census Bureau. Building Permits Survey.") + 
  theme(panel.grid.major.y = element_line(color = "white"),
        panel.grid.major.x = element_line(color = "#f5f5f5",size = 0.1),
        axis.text.x = element_text(angle = 90)) +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    )))

# girafe(ggobj = bps_plot,
#        height_svg = 4)

bps_plot

```

Single-family construction starts (which includes single-family attached housing) are high in the largest counties in the region, where greenfield development opportunities are numerous. Infill development opportunities in the City of Richmond limit the ability for substantial new supply, but opportunities still exist for resale and redevelopment.

```{r}
#| label: fig-bps
#| fig-cap: "Total new single-family residential building permits issued from 2000 to 2023"

# Create a visualization that shows where 2+ housing is being built. Where is more diverse housing being built? 

density <- c("Hanover", "Henrico", "Chesterfield", "Richmond")

bps <- read_rds("data/planrva/rds/rva_bps.rds") |> # Load in Building Permits Survey data.
  mutate(type = case_when( # Group "Missing Middle" housing together.
    type == "2-units" ~ "2-4 units",
    type == "3-4 units" ~ "2-4 units",
    TRUE ~ type
  )) |> 
  group_by(name_long, year, type) |> # Aggregate to locality and housing type.
  summarise(units = sum(units)) |> 
  group_by(name_long) |> # Group by locality.
  mutate(total = sum(units)) |> # Calculate the total number of new permits for entire time period.
  filter(type == "1-unit") 


# subtitle_text <- "Few <span style = 'color:#40C0C0'><b>2-4 unit housing</span> has been built between 2000 to 2023"
  
bps_plot <- ggplot(bps,
       aes(x = reorder(name_long, units),
           y = units,
           fill = type,
           data_id = units,
           tooltip = number_format(big.mark =",")(units))) + 
  geom_col_interactive(position = "stack") +
  theme_hfv(base_size = 10) + 
  scale_fill_hfv() +
  scale_y_continuous(labels = number_format(big.mark = ",", style_positive = "plus")) +
  labs(title = "Total new 1-unit residential building permits issued in the PlanRVA region",
       caption = "**Source:** U.S. Census Bureau. Building Permits Survey.") + 
  theme(panel.grid.major.y = element_line(color = "white"),
        panel.grid.major.x = element_line(color = "#f5f5f5",size = 0.1),
        axis.text.x = element_text(angle = 90)) +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    )))

# girafe(ggobj = bps_plot,
#        height_svg = 4)

bps_plot

```

Observing variations across jurisdictions, it may surprise many that Chesterfield County exceeds the City of Richmond in 2-4 unit and 5 or more unit construction starts.

```{r}
#| label: fig-bps
#| fig-cap: "Total new 2+ residential building permits issued from 2000 to 2023"

# Create a visualization that shows where 2+ housing is being built. Where is more diverse housing being built? 

density <- c("Hanover", "Henrico", "Chesterfield", "Richmond", "Goochland")

bps <- read_rds("data/planrva/rds/rva_bps.rds") |> # Load in Building Permits Survey data.
  mutate(type = case_when( # Group "Missing Middle" housing together.
    type == "2-units" ~ "2-4 units",
    type == "3-4 units" ~ "2-4 units",
    TRUE ~ type
  )) |> 
  group_by(name_long, year, type) |> # Aggregate to locality and housing type.
  summarise(units = sum(units)) |> 
  group_by(name_long) |> # Group by locality.
  mutate(total = sum(units)) |> # Calculate the total number of new permits for entire time period.
  filter(type != "1-unit") |> 
  filter(name_long %in% density)


subtitle_text <- "Few <span style = 'color:#40C0C0'><b>2-4 unit housing</span> has been built between 2000 to 2023"
  
bps_plot <- ggplot(bps,
       aes(x = reorder(name_long, units),
           y = units,
           fill = type,
           data_id = units,
           tooltip = number_format(big.mark =",")(units))) + 
  geom_col_interactive(position = "stack") +
  facet_wrap(~type) +
  theme_hfv(base_size = 10) + 
  scale_fill_hfv() +
  scale_y_continuous(labels = number_format(big.mark = ",", style_positive = "plus")) +
  labs(title = "Total new residential building permits issued in the PlanRVA region",
       subtitle = subtitle_text,
       caption = "**Source:** U.S. Census Bureau. Building Permits Survey.") + 
  theme(panel.grid.major.y = element_line(color = "white"),
        panel.grid.major.x = element_line(color = "#f5f5f5",size = 0.1),
        axis.text.x = element_text(angle = 90)) +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    )))

# girafe(ggobj = bps_plot,
#        height_svg = 4)

bps_plot

```



```{r}
#| label: fig-pct-renter
#| fig-cap: "Percent of renter households in the PlanRVA region"
#| eval: false

tenure <- read_rds("data/planrva/rds/b25003.rds") |> 
  filter(year == 2010 | year == 2022) |> 
  filter(tenure == "Renter") |> 
  mutate(year = as.character(year)) 

subtitle_text <- "In <span style = 'color:#011E41'><b>2010</b></span> and <span style = 'color:#40C0C0'><b>2022</span>"

# tenure_plot <- 
  
ggplot(tenure,
       aes(x = reorder(NAME, pct),
           y = pct,
           color = year)) +
  geom_line(size = 1, color = "grey") +
  geom_point_interactive(aes(color = year,
                             data_id = pct,
                             tooltip = percent_format(accuracy = 1)(pct)), 
                         size = 2) +
  coord_flip() +
  theme_hfv() +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Percent of renter households in Hampton Roads",
       subtitle = subtitle_text,
       caption = "**Source:** U.S. Census Bureau, ACS, 5-Year Estimates, Table B25003.") +
  scale_color_hfv() +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    ))) + 
  theme(panel.grid.major.y = element_line(color = "white"),
        panel.grid.major.x = element_line(color = "#dadada",size = 0.1))


```

```{r}
#| label: fig-pct-homeowner
#| fig-cap: "Homeownership in the PlanRVA region"
#| eval: false

tenure <- read_rds("data/planrva/rds/b25003.rds") |>
  group_by(year, NAME, tenure) |> 
  summarise(estimate = sum(estimate)) |> 
  ungroup() |> 
  group_by(year, NAME) |> 
  mutate(total = sum(estimate)) |> 
  mutate(pct = estimate/total) |> 
  filter(tenure == "Homeowner") |> 
  filter(year == 2010 | year == 2022) |> 
  mutate(year = as.character(year)) 


subtitle_text <- "In <span style = 'color:#011E41'><b>2010</b></span> and <span style = 'color:#40C0C0'><b>2022</span>"

# tenure_plot <- 
  
ggplot(tenure,
       aes(x = reorder(NAME, pct),
           y = pct,
           color = year)) +
  geom_line(size = 1, color = "grey") +
  geom_point_interactive(aes(color = year,
                             data_id = pct,
                             tooltip = percent_format(accuracy = 1)(pct)), 
                         size = 2) +
  coord_flip() +
  theme_hfv() +
  scale_y_continuous(labels = percent_format(), limits = c(.35, 1)) +
  labs(title = "Homeownership rate in the PlanRVA region",
       subtitle = subtitle_text,
       caption = "**Source:** U.S. Census Bureau, ACS, 5-Year Estimates, Table B25003.") +
  scale_color_hfv() +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    ))) + 
  theme(panel.grid.major.y = element_line(color = "white"),
        panel.grid.major.x = element_line(color = "#dadada",size = 0.1))

#   
# girafe(ggobj = tenure_plot,
#        height_svg = 4)

```

The median home sales price in the Richmond Metropolitan Area has reached \$400,000 as of the second quarter of 2024. This is a far cry from 2014 when the median price was under \$200,000. And while it is important to note that the value of the dollar has changed over time, everyday people interpret home prices based on their experience at the time. For that reason, we present the median home sales price in nominal dollars (i.e. what the price was at that time). 

```{r}
#| label: fig-rva-price
#| fig-cap: "Median home sales price in Richmond MSA"

# What have home prices been like?


rva_var_price <- read_rds("data/planrva/rds/rva_var.rds") |> 
  select(geography, period, name, med_price, adj_price) |> 
  pivot_longer(4:5,
               names_to = "type",
               values_to = "price") |> 
  mutate(type = case_when(
    type == "adj_price" ~ "Adjusted Price",
    type == "med_price" ~ "Nominal Price"
  )) |> 
  filter(type == "Nominal Price") |> 
  filter(name == "Richmond MSA") 

subtitle_text <- "In <span style = 'color:#011E41'><b>nominal dollars</b></span>"

 ggplot(rva_var_price,
       aes(x = period,
           y = price,
           color = name,
           linetype = type)) +
  geom_line() +
  geom_point() +
  theme_hfv(base_size = 10) +
  scale_color_hfv() +
  scale_y_continuous(labels = dollar_format()) +
  # theme(legend.position = "top") +
  labs(subtitle = subtitle_text)
 
```


```{r}
  
rva_var_price <- read_rds("data/planrva/rds/rva_var.rds") |> 
  select(geography, period, name, med_price, adj_price) |> 
  mutate(year = substr(period, 1, 4)) |> 
  mutate(year = as.numeric(year)) |> 
  filter(period == "2024 Q1" | period == "2014 Q1") |> 
  mutate(period = as.character(period)) |> 
  select(geography, name, med_price, adj_price, period) |> 
  pivot_longer(3:4,
               names_to = "type",
               values_to = "price") |> 
  mutate(name = case_when(
    name == "Virginia Beach-Norfolk-Newport News MSA" ~ "VB-Norfolk-NN MSA",
    TRUE ~ name
  ))

ggplot(rva_var_price,
       aes(x = type,
           y = price,
           fill = period)) +
  geom_col(position = "dodge") +
  facet_wrap(~name)
  

|> 
  pivot_wider(names_from = period, 
              values_from = med_price) |> 
  mutate(latest = `2024 Q1`) 

|> 
  pivot_longer(3:4,
               names_to = "period",
               values_to = "med_price") |> 
  mutate(name = case_when(
    name == "Virginia Beach-Norfolk-Newport News MSA" ~ "VB-Norfolk-NN MSA",
    TRUE ~ name
  ))
  
subtitle_text <- "In <span style = 'color:#011E41'><b>Q1 2014</b></span> and <span style = 'color:#40C0C0'><b>Q1 2024</span>"


price_plot <- ggplot(rva_var_price,
       aes(x = reorder(name, latest),
           y = med_price,
           color  = period)) +
  theme_hfv(base_size = 10) +
  geom_line(linewidth = 1, color = "grey") +
  geom_point_interactive(aes(
           data_id = med_price,
           tooltip = dollar_format()(med_price))) +
  coord_flip() +
  labs(title = "Median home sales price in Richmond region",
       subtitle = subtitle_text,
       caption = "**Source:** Virginia REALTORS, adjusted to Q2 2024 dollars.") +
  scale_y_continuous(labels = dollar_format(), limits = c(100000, 700000)) +
  scale_color_hfv() +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    ))) + 
  theme(panel.grid.major.y = element_line(color = "white"),
        panel.grid.major.x = element_line(color = "#dadada",size = 0.2))

price_plot
  
girafe(ggobj = price_plot,
       height_svg = 4)

```



```{r}
#| label: fig-rva-dom
#| fig-cap: "Median days on market in the Richmond region"


# How to add arrows indicating direction on line segments??
subtitle_text <- "In <span style = 'color:#011E41'><b>Q2 2019</b></span> and <span style = 'color:#40C0C0'><b>Q2 2024</span>"

library(patchwork)

rva_var_dom <- read_rds("data/planrva/rds/rva_var.rds") |> 
  select(geography, name, period, med_dom)  |> 
  mutate(year = substr(period, 1, 4)) |> 
  mutate(year = as.numeric(year)) |> 
  filter(period == "2024 Q2" | period == "2019 Q2") |> 
  mutate(period = as.character(period)) |> 
  select(geography, name, med_dom, period) |> 
  pivot_wider(names_from = period, 
              values_from = med_dom) |> 
  mutate(latest = `2019 Q2`) |> 
  pivot_longer(c(`2024 Q2`, `2019 Q2`),
               names_to = "period",
               values_to = "med_dom") 

dom_plot <- ggplot(rva_var_dom,
       aes(x = reorder(name, latest),
           y = med_dom,
           color = period)) +
  geom_line(size = 1, color = "grey") +
  geom_point_interactive(aes(
    data_id = med_dom,
    tooltip = med_dom)) +
  theme_hfv() +
  # geom_text(data = subset(rva_var_dom, 
  #                         name %in% c("Williamsburg",  "VB-Norfolk-NN MSA", "Surry County")), 
  #           aes(label = med_dom, hjust = ifelse(period == "2023 Q2", 1.50, -0.5)),
  #           size = 3) +
  coord_flip() +
  labs(title = "Median days on market in the Richmond region",
       subtitle = subtitle_text,
       caption = "**Source:** Virginia REALTORS.")  +
  scale_y_continuous(limits = c(0, 35)) +
  scale_color_hfv() +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    ))) + 
  theme(panel.grid.major.y = element_line(color = "white"),
        panel.grid.major.x = element_line(color = "#dadada",size = 0.2))

girafe(ggobj = dom_plot,
       height_svg = 4)
  



```

```{r}
#| label: fig-rva-rent
#| fig-cap: "Average asking rent in Richmond region"



rva_rent <- read_rds("data/planrva/rds/rva_costar.rds") |> 
  select(period, rent, adj_price) |> 
  mutate(quarters = as.yearqtr(period)) |> 
  pivot_longer(2:3,
               names_to = "rent",
               values_to = "dollars")

subtitle_text <- "In <span style = 'color:#011E41'><b>Q2 2024 dollars</b></span> and <span style = 'color:#40C0C0'><b>nominal dollars</span>"

rent_plot <- ggplot(rva_rent,
       aes(x = quarters,
           y = dollars,
           color = rent,
           linetype = rent)) +
  geom_line() +
  geom_point_interactive(aes(
    data_id = dollars,
    tooltip = dollar_format()(dollars)
  )) +
  theme_hfv() +
  scale_y_continuous(labels = dollar_format()) +
  scale_x_yearqtr(breaks = seq(from = min(rva_rent$quarters), 
                               to = max(rva_rent$quarters), 
                               by = 1),format = '%Y-Q%q') +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Average asking rent in Richmond region",
       subtitle = subtitle_text,
       caption = "**Source:** CoStar Group, Inc.") +
  scale_color_hfv()  +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    ))) + 
  theme(panel.grid.major.y = element_line(color = "#dadada", size = 0.1),
        panel.grid.major.x = element_line(color = "#dadada",size = 0.1))
  # scale_color_gradientn(colours = c("#ADDCB1", "#46A88F", "#207A88", "#0F1A4E"))

girafe(ggobj = rent_plot,
       height_svg = 4)

```

```{r}
#| label: fig-rva-rv
#| fig-cap: "Rental vacancy in Richmond region"

rva_rv <- read_rds("data/planrva/rds/rva_costar.rds") |> 
  select(period, vacancy_rate) |> 
  mutate(quarters = as.yearqtr(period))

vacancy_plot <- ggplot(rva_rv,
       aes(x = quarters,
           y = vacancy_rate,
           color = vacancy_rate)) +
  geom_line() +
  geom_point_interactive(aes(
    data_id = vacancy_rate,
    tooltip = percent_format(accuracy = 0.01)(vacancy_rate)
  )) +
  theme_hfv() +
  scale_y_continuous(labels = percent_format()) +
  scale_x_yearqtr(breaks = seq(from = min(rva_rv$quarters), to = max(rva_rv$quarters), by = 1),
                  format = '%Y-Q%q') +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Rental vacancy rate in Richmond region",
       caption = "**Source:** CoStar Group, Inc.") + 
  scale_color_gradientn(colours = c("#ADDCB1", "#46A88F", "#207A88", "#0F1A4E"))

girafe(ggobj = vacancy_plot,
       height_svg = 4)

```
