# Northern Virginia’s Land Use Restrictions in Context {part-3-2}

```{r}
#| label: setup

library(tidyverse)
library(tidycensus)
library(ggplot2)
library(ggiraph)
library(sf)
library(leaflet)
library(FinCal)
library(hdatools)
library(scales)
library(forcats)
library(kableExtra)
library(ggtext)
library(patchwork)
library(forcats)
library(fredr)
# Summarize the key findings from the analysis below.

# Describe the housing market in relation to population growth and household trends in the region. 

# Is the population growing or snovainking? What is the typical household size?
# Are we building the housing to match the growth and typical household?

# Describe economic trends in the region.

# Is there job growth in the region? Are incomes and wages growing or declining?
# What can the typical renter afford to buy or rent?
# What can the top occupations afford to buy or rent?

# Describe zoning's impact in Hampton Roads.

# How much of zoned land in Hampton Roads is dedicated to single-family housing only (% of total acres)? Total and by locality. Ranked.
# How much of zoned land in Hampton Roads is primarily residential, mixed with residential, and nonresidential (% of total acres)? Total and by locality. Ranked.
# How much of zoned land in Hampton Roads allows for 2+ family by-right (% of total acres)?
# Housing type by-right by locality
# Where are there minimum square footage requirements?
# How much of zoned land in Hampton Roads allows for ADUs by-right?
# What is the average minimum lot acres for each treatment?


```

In the following section we describe Northern Virginia’s housing market under these land use rules and compare Northern Virginia to peer regions.

While land-use regulations across Northern Virginia limit housing construction and drive up its costs, the commonwealth’s population is growing faster than the U.S. as a whole. Relative to some high-demand parts of the country, Virginia’s regulatory burden is lighter. The slowest growing jurisdiction (Fairfax County) grew 5.23% from 2010 to 2022, the median jurisdiction (Manassas) grew 12.75%, and the fastest growing jurisdiction (Loudoun County) grew 38.35%. As a point of comparison, California grew only 4.6% over this time period and has lost population in the most recent years as land use regulations have prevented new construction in the face of high house prices.

```{r}
#| label: fig-nova-city-pop
#| fig-cap: "Population Growth across Northern Virginia from 2010 to 2022"

# Create a visualization that shows population change in the region by city. What localities are seeing the most growth? Which ones are seeing decline?

# nova_pop <- read_rds("data/nova/nova_pop.rds") |> 
#   mutate(year = as.numeric(year)) |> 
#   filter(year >= 2010) |> 
#   group_by(name_long) |>
#   mutate(diff = value - lag(value),
#          diff = replace_na(diff, 0)) |> 
#   mutate(run_diff = cumsum(diff))|>  
#   filter(run_diff != 0) |> 
#   mutate(year = as.character(year)) |> 
#   mutate(type = case_when(
#     str_detect(name_long, "City") ~ "City",
#     TRUE ~ "County"
#   )) |> 
#   filter(year == 2022)

nova_pop_total <- read_rds("data/nova/nova_pop.rds") |> # Load in population data for Northern Virginia.
  mutate(year = as.numeric(year)) |> # Convert the year column to a number instead of character.
  filter(year == 2010 | year == 2022) |> # Filter for earliest and latest year.
  select(name_long, year, value) |> # Select only needed fields.
  pivot_wider(names_from = year, 
              values_from = value) |> 
  mutate(total_2010 = sum(`2010`),
         total_2022 = sum(`2022`)) |> 
  mutate(change = total_2022 - total_2010) |> # Calculate change in population for entire region.
  mutate(pchg = change/total_2010) |> # Calculate percent change in population for entire region.
  mutate(lpchg = (`2022` - `2010`)/`2010`) |> # Calculate percent change for each locality.
  mutate(name_long = str_remove(name_long, " City")) |> # Remove " City" from each locality.
  mutate(name_long = case_when( # Add back in City to James City County.
    name_long == "Fairfax" ~ "Fairfax City",
    TRUE ~ name_long
  ))
         
ggplot(nova_pop_total, # Read in the data.
                  aes(x = reorder(name_long, lpchg), # Plot the x-axis.
                      y = lpchg, # Plot the y-axis.
                      fill = lpchg)) + # Set the variable that will be colored.
  geom_col(position = "dodge") + # Set as a bar chart. 
  geom_text(aes(label = percent(lpchg, 2), hjust = ifelse(lpchg >= 0, 0, 1), color = lpchg)) +
  coord_flip() +
  theme_hfv() + # Apply custom HFV theme.
  add_zero_line("y") + # Add darker zero intercept line for emphasis.
  labs(subtitle = "From 2010 to 2022",
       caption = "**Source:** U.S. Census Bureau, Population Estimates Program (PEP).") +
  scale_y_continuous(label = percent_format(), expand = expansion(mult = c(0, 0.1))) + 
  scale_fill_gradientn(colours = c("#ADDCB1", "#46A88F", "#207A88", "#0F1A4E")) +
  scale_color_gradientn(colours = c("#ADDCB1", "#46A88F", "#207A88", "#0F1A4E"))

```

In spite of Virginia’s relative accommodation of population growth, house prices have increased here as well. Between 2019 and 2023, the greater D.C. area saw an increase of roughly 13% after adjusting for inflation. Out of 9 jurisdictions, only 2, Arlington County and Falls Church, saw a decline in the median sale price during this time period.

```{r}
#| label: fig-nova-price
#| fig-cap: "Median home sales price in Northern Virginia"

# What have home prices been like?

# How to add arrows indicating direction on line segments??

nova_var_price <- read_rds("data/nova/nova_var.rds") |> 
  select(geography, period, name, adj_price) |> 
  mutate(year = substr(period, 1, 4)) |> 
  mutate(year = as.numeric(year)) |> 
  filter(period == "2023 Q2" | period == "2019 Q2") |> 
  mutate(period = as.character(period)) |> 
  select(geography, name, adj_price, period) |> 
  pivot_wider(names_from = period, 
              values_from = adj_price) |> 
  mutate(latest = `2023 Q2`) |> 
  pivot_longer(3:4,
               names_to = "period",
               values_to = "med_price") |> 
  mutate(name = case_when(
    name == "Virginia Beach-Norfolk-Newport News MSA" ~ "VB-Norfolk-NN MSA",
    TRUE ~ name
  )) |> 
  mutate(name = str_remove(name, " City"))  |> 
  mutate(name = case_when(
    name == "Fairfax" ~ "Fairfax City",
    TRUE ~ name
  ))
  
subtitle_text <- "In <span style = 'color:#011E41'><b>Q2 2019</b></span> and <span style = 'color:#40C0C0'><b>Q2 2023</span>"


price_plot <- ggplot(nova_var_price,
       aes(x = reorder(name, latest),
           y = med_price,
           color  = period)) +
  theme_hfv() +
  geom_line(linewidth = 1, color = "grey") +
  geom_point_interactive(aes(
           data_id = med_price,
           tooltip = dollar_format()(med_price))) +
  geom_text(data = subset(nova_var_price, 
                          name %in% c("Washington MSA")),
            aes(label = dollar(med_price),
                hjust = ifelse(period == "2023 Q2", -0.25, 1.25)), 
            size = 3) +
  coord_flip() +
  labs(title = "Median home sales price in Northern Virginia",
       subtitle = subtitle_text,
       caption = "**Source:** Virginia REALTORS, adjusted to Q2 2023 dollars.") +
  scale_y_continuous(labels = dollar_format(), limits = c(300000, 1100000)) +
  scale_color_hfv() +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    ))) + 
  theme(panel.grid.major.y = element_line(color = "white"),
        panel.grid.major.x = element_line(color = "#dadada",size = 0.2))
  
girafe(ggobj = price_plot,
       height_svg = 4)

```

Since 2010, average rents in Northern Virginia have climbed almost \$200 after adjusting for inflation; the vacancy rate has been consistently lower than the national rate, with an exception for the depths of the pandemic.

```{r}
#| label: fig-nova-rent
#| fig-cap: "Average asking rent in Northern Virginia"

# What has rent been like in Northern Virginia?

nova_rent <- read_rds("data/nova/rds/nova_costar.rds") |> 
  select(period, rent, adj_price) |> 
  mutate(quarters = as.yearqtr(period)) |> 
  pivot_longer(2:3,
               names_to = "rent",
               values_to = "dollars") |> 
  filter(rent == "adj_price")

subtitle_text <- "In <span style = 'color:#011E41'><b>Q4 2023 dollars</b></span>"

rent_plot <- ggplot(nova_rent,
       aes(x = quarters,
           y = dollars,
           color = rent,
           linetype = rent)) +
  geom_line() +
  geom_point_interactive(aes(
    data_id = dollars,
    tooltip = dollar_format()(dollars)
  )) +
  theme_hfv() +
  scale_y_continuous(labels = dollar_format()) +
  scale_x_yearqtr(breaks = seq(from = min(nova_rent$quarters), 
                               to = max(nova_rent$quarters), 
                               by = 1),format = '%Y-Q%q') +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(subtitle = subtitle_text,
       caption = "**Source:** CoStar Group, Inc.") +
  scale_color_hfv()  +
  plot_annotation(
    theme = theme(
    plot.subtitle = element_markdown(
       margin = margin(b = 0.4, unit = 'cm'),
        size = 11.5
    ))) +
  scale_x_yearqtr(breaks = seq(from = min(nova_rent$quarters), 
                               to = max(nova_rent$quarters), 
                               by = 1),format = '%Y') +
  labs(subtitle = subtitle_text) + 
  scale_color_hfv()  +
  theme(panel.grid.major.y = element_line(color = "#dadada",size = 0.1),
        panel.grid.major.x = element_line(color = "#dadada",size = 0.1),
        axis.text.x = element_text(angle = 90))

girafe(ggobj = rent_plot,
       height_svg = 4)

```

```{r}
#| label: fig-nova-rv
#| fig-cap: "Rental Vacancy Rate in Northern Virginia from 2010 to 2023"


# What has rental vacancy been like?

nova_rv <- read_rds("data/nova/nova_costar.rds") |> 
  select(period, vacancy_rate) |> 
  mutate(quarters = as.yearqtr(period))

vacancy_plot <- ggplot(nova_rv,
       aes(x = quarters,
           y = vacancy_rate,
           color = vacancy_rate)) +
  geom_line() +
  geom_point_interactive(aes(
    data_id = vacancy_rate,
    tooltip = percent_format(accuracy = 0.01)(vacancy_rate)
  )) +
  theme_hfv() +
  scale_y_continuous(labels = percent_format()) +
  scale_x_yearqtr(breaks = seq(from = min(nova_rv$quarters), to = max(nova_rv$quarters), by = 1),
                  format = '%Y-Q%q') +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(caption = "**Source:** CoStar Group, Inc.") + 
  scale_color_gradientn(colours = c("#ADDCB1", "#46A88F", "#207A88", "#0F1A4E"))

girafe(ggobj = vacancy_plot,
       height_svg = 4)

```

Across the country, local governments use similar types of rules to restrict housing construction, but the extent of these restrictions varies widely. The substantial affordability challenges caused by land use regulations in Northern Virginia and the DC area notwithstanding, this region is more open to housing construction than other metropolitan coastal regions. For example, during the construction of rail transit in Arlington, the county upzoned nearby areas, allowing for more multifamily construction.[^part-3-2-1] Fairfax County adopted a transit-oriented development plan in Tysons, allowing a large increase in multifamily construction. Loudoun County is the region’s fastest growing municipality due in large part to greenfield construction, but its growth includes substantial townhouse and multifamily construction as well as detached single-family construction.

[^part-3-2-1]: Emily Hamilton, “How DC Densified,” Works in Progress, May 23, 2023. <https://worksinprogress.co/issue/how-dc-densified/>

In contrast, the suburbs of other high-income coastal regions such as the Bay Area, Boston, Los Angeles, and New York City have allowed much less multifamily construction. Some of Boston’s suburbs lie in New Hampshire, a state with a completed zoning atlas. 93% of New Hampshire’s developable land is restricted to exclusively detached single-family zoning, compared to 71% in Northern Virginia. In New Hampshire, single-family houses on lots less than one acre are only allowed on 15% of developable land, while 75% of Northern Virginia districts that allow for residential construction have a plausible minimum lot size requirement of less than one acre.

The price of housing in the Northern Virginia area is above the national average, but the D.C. metropolitan area is far less expensive than comparable regions that permit less housing construction. Since the turn of the millennium, while D.C.’s prices have been between 47% and 115% higher than national prices, Boston’s have been 77% to 118% higher, New York’s 80% to 140%, Los Angeles’ prices 85% to 192% higher, and San Francisco’s 141% to 309% higher. As our atlas data shows, policymakers in Northern Virginia have ample opportunities to reduce the barrier of local land use regulations. However, the problems caused by housing supply constraints are more severe in more heavily regulated peer regions.

```{r}
#| label: fig-natl-prices
#| fig-cap: "Median Home Values in Select High-Income Coastal Regions as a Multiple of the U.S. Median"

metro_prices <- read_csv("data/nova/zvhi.csv")

city_names <- c("United States", 
                "Washington, DC", 
                "New York, NY", 
                "Los Angeles, CA", 
                "San Francisco, CA", 
                "Boston, MA")

metro_prices <- metro_prices |>
  filter(RegionName %in% city_names)

metro_prices <- metro_prices %>%
  gather(key = "Date", value = "Price", -c(RegionID, RegionName, RegionType, StateName, SizeRank))

metro_prices$Date <- as.Date(metro_prices$Date)

metro_prices <- metro_prices %>%
  group_by(Date) %>%
  mutate(relative_price = Price / Price[RegionName == "United States"]) %>%
  ungroup()

order_region <- metro_prices %>%
  group_by(RegionName) %>%
  summarise(last_relative_price = last(relative_price)) %>%
  arrange(desc(last_relative_price)) %>%
  pull(RegionName)

metro_prices$RegionName <- factor(metro_prices$RegionName, levels = order_region)

metro_prices_img <- ggplot(metro_prices,
                           aes(x = Date,
                               y = relative_price,
                               group = RegionName,
                               color = RegionName)) +
  geom_line() +
  geom_line(data = filter(metro_prices, RegionName == "Washington, DC"), 
            aes(x = Date, y = relative_price), 
            size = 1.5) + 
  scale_color_hfv() +
  scale_x_date(breaks = "4 years",
               date_labels = "%Y") +
  theme_hfv() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "right")


```

## Conclusion

The NZA data provides an important new tool for advocates of zoning reform and opens up new opportunities for researchers to study the effects of specific zoning rules and combinations of rules. We find that in spite of high demand to live in Northern Virginia, a majority of the land cannot be developed with more than one detached housing unit and requirements for large lots are pervasive. Nonetheless, we can see in many peer regions of the country, barriers to housing construction are higher, corresponding with more severe affordability problems. Northern Virginia already has a successful blueprint for reforming exclusionary zoning with examples like Arlington’s transit corridors. The zoning atlas provides details on the rules that are facilitating construction across the region, pointing to reforms that could address the housing shortage in the large parts of the region where development is currently locked out.

```{r}
#| label: fig-2plus
#| fig-cap: "Percent of developable land allowing for 2+ family housing by-right" 

# Create a bar graph that shows the total amount of zoned land that welcomes 2+ family housing by-right



nova_byright_summary <- read_rds("data/nova/rds/nova_vza_nogeo.rds") |> 
  select(jurisdiction, abbrvname, overlay, 6:9, acres) |> # Select data fields.
  filter(overlay == 0) |> # Filter out overlay districts.
  mutate(total_area = sum(acres)) |> # Calculate the total area of zoned land.
  filter(family4_treatment == "allowed") |> 
  mutate(total_4plus = sum(acres)) |> 
  mutate(pct4plus = total_4plus/total_area)

```